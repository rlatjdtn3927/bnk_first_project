<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>통합 검색 결과</title>
  <link rel="stylesheet" th:href="@{/css/header.css}" />
  <link rel="stylesheet" th:href="@{/css/footer.css}" />
  <link rel="stylesheet" th:href="@{/css/search.css}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <div th:replace="~{fragments/header :: mainHeader}"></div>

  <main class="search-main">
    <h2 class="search-title">통합 검색</h2>

    <div class="search-box">
      <i class="fas fa-magnifying-glass search-icon"></i>
      <input type="text" id="search-input" placeholder="검색어를 입력하세요" onkeypress="handleEnter(event)" />
    </div>

    <p class="search-info" id="search-info"></p>

    <div class="category-tabs">
      <button class="tab-btn active" data-group="전체">전체</button>
      <button class="tab-btn" data-group="상품">상품</button>
      <button class="tab-btn" data-group="매뉴얼">매뉴얼</button>
      <button class="tab-btn" data-group="자주찾는질문">자주찾는질문</button>
      <button class="tab-btn" data-group="공지사항">공지사항</button>
      <button class="tab-btn" data-group="공시">공시</button>
    </div>

    <div id="search-results"></div>
  </main>

  <div th:replace="~{fragments/footer :: mainFooter}"></div>

  <script>
    let allSections = [];
    const sectionStore = new Map();
    const sectionOffset = new Map();

    document.addEventListener("DOMContentLoaded", () => {
      const keyword = new URLSearchParams(location.search).get("keyword");
      if (keyword) {
        document.getElementById("search-input").value = keyword;
        fetchResults(keyword);
      }

      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          renderSections(btn.dataset.group);
        });
      });

      document.getElementById("search-results").addEventListener("click", e => {
        if (e.target.classList.contains("more-link")) {
          e.preventDefault();
          const key = e.target.dataset.key;
          const category = e.target.dataset.category;
          const subCategory = e.target.dataset.subcategory;

          const full = sectionStore.get(key);
          let offset = sectionOffset.get(key);
          const section = e.target.closest(".result-group");
          const list = section.querySelector(".result-list");

          if (offset >= full.length) {
            const collapsed = full.slice(0, 3);
            list.innerHTML = collapsed.map(item => buildItemHtml(item, category, subCategory)).join("");
            sectionOffset.set(key, 3);
            e.target.textContent = "더보기 ▾";
          } else {
            const next = full.slice(offset, offset + 5);
            list.insertAdjacentHTML("beforeend", next.map(item => buildItemHtml(item, category, subCategory)).join(""));
            offset += next.length;
            sectionOffset.set(key, offset);

            if (offset >= full.length) {
              e.target.textContent = "접기 ▲";
            }
          }
        }
      });
    });

    function handleEnter(e) {
      if (e.key === "Enter") {
        const kw = e.target.value.trim();
        if (kw) location.href = `/search?keyword=${encodeURIComponent(kw)}`;
      }
    }

    async function fetchResults(keyword) {
   	  const info = document.getElementById("search-info");
   	  const container = document.getElementById("search-results");
   	  container.innerHTML = "";
   	  info.textContent = `"${keyword}" 검색 중…`;

   	  try {
   	    const res = await fetch(`/api/search?keyword=${encodeURIComponent(keyword)}`);
   	    allSections = await res.json() || [];
   	    const totalCount = allSections.reduce((sum, sec) => sum + sec.count, 0);

   	    info.innerHTML =
   	      `"${keyword}" 총 <span class="highlight">${totalCount}</span>건이 검색되었습니다.`;

   	    updateTabCounts(allSections);
   	    renderSections("전체");

   	    container.classList.remove("fade-animate");
   	    void container.offsetWidth;
   	    container.classList.add("fade-animate");

   	  } catch (err) {
   	    console.error(err);
   	    info.textContent = "검색 중 오류가 발생했습니다.";
   	  }
   	}


    function updateTabCounts(sections) {
      const counts = {
        "전체": sections.reduce((sum, sec) => sum + sec.count, 0),
        "상품": 0,
        "매뉴얼": 0,
        "자주찾는질문": 0,
        "공지사항": 0,
        "공시": 0
      };
      sections.forEach(sec => {
        if (counts[sec.category] != undefined) {
          counts[sec.category] += sec.count;
        }
      });
      document.querySelectorAll(".tab-btn").forEach(btn => {
        const group = btn.dataset.group;
        btn.innerHTML = `${group} <span>(${counts[group]})</span>`;
      });
    }


    function renderSections(group) {
   	  const container = document.getElementById("search-results");
   	  container.innerHTML = "";

   	  const filtered = group === "전체"
   	    ? allSections
   	    : allSections.filter(sec => sec.category === group);

   	  const grouped = new Map();
   	  filtered.forEach(section => {
   	    if (section.count === 0 || !section.items?.length) return;

   	    if (section.category === "상품") {
   	      if (!grouped.has("상품")) grouped.set("상품", new Map());
   	      grouped.get("상품").set(section.subCategory || "기타", section);
   	    } else {
   	      grouped.set(section.category, section);
   	    }
   	  });

   	  let drewSomething = false; 

   	  for (const [category, data] of grouped.entries()) {
   	    if (category === "상품") {
   	      const section = document.createElement("section");
   	      section.className = "result-group";

   	      const header = document.createElement("div");
   	      header.className = "result-header";
   	      header.innerHTML = `<h3>${category}</h3>`;
   	      section.appendChild(header);

   	      let i = 0;
   	      for (const [subCategory, subSection] of data.entries()) {
   	        if (i++ > 0) {
   	          const hr = document.createElement("hr");
   	          hr.className = "sub-divider";
   	          section.appendChild(hr);
   	        }

   	        const key = `${category} > ${subCategory}`;
   	        sectionStore.set(key, subSection.items);
   	        sectionOffset.set(key, 3);

   	        const subWrap = document.createElement("div");
   	        subWrap.className = "subcategory-section";

   	        const subHeader = document.createElement("h4");
   	        subHeader.innerHTML = `${subCategory} <span>(${subSection.count})</span>`;
   	        subWrap.appendChild(subHeader);

   	        const list = document.createElement("div");
   	        list.className = "result-list";
   	        list.innerHTML = subSection.items.slice(0, 3).map(item => buildItemHtml(item, category, subCategory)).join("");
   	        subWrap.appendChild(list);

   	        if (subSection.count > 3) {
   	          const more = document.createElement("div");
   	          more.className = "result-footer";
   	          more.innerHTML = `<a href="#" class="more-link" data-key="${key}" data-category="${category}" data-subcategory="${subCategory}">더보기 ▾</a>`;
   	          subWrap.appendChild(more);
   	        }

   	        section.appendChild(subWrap);
   	      }

   	      container.appendChild(section);
   	      drewSomething = true; 
   	    } else {
   	      const key = data.subCategory ? `${data.category} > ${data.subCategory}` : data.category;
   	      sectionStore.set(key, data.items);
   	      sectionOffset.set(key, 3);
   	      appendSection(container, key, data.category, data.subCategory);
   	      drewSomething = true;
   	    }
   	  }

   	  if (!drewSomething) {
   		container.innerHTML = `<p class="no-result">선택한 카테고리에 대한 검색 결과가 없습니다.</p>`;
   	  }
   	}


   function appendSection(container, key, category, subCategory) {
   	  const total = sectionStore.get(key).length;
   	  const firstBatch = sectionStore.get(key).slice(0, 3);

   	  const section = document.createElement("section");
   	  section.className = "result-group";
   	  section.dataset.key = key;

	   	section.innerHTML = `
	   	  <div class="result-header">
	   	    <h3>${category}<span class="item-count">(${total})</span></h3>
	   	  </div>
	   	  <div class="result-list">
	   	    ${firstBatch.map(item => buildItemHtml(item, category, subCategory)).join("")}
	   	  </div>
	   	  ${total > 3 ? `
	   	    <div class="result-footer">
	   	      <a href="#" class="more-link"
	   	         data-key="${key}" data-category="${category}" data-subcategory="${subCategory}">
	   	         더보기 ▾
	   	      </a>
	   	    </div>` : ""}
	   	`;


   	  container.appendChild(section);
   	}


    function buildItemHtml(item, category, subCategory) {
      const kw = document.getElementById("search-input").value.trim();

      if (category === "상품" && subCategory === "디폴트옵션") {
        return `
          <div class="result-item">
            <div class="item-main">
              <p class="item-title">${highlight(item.prodName, kw)}</p>
              <p class="item-snippet">${highlight(item.subProd1, kw)}</p>
              <p class="item-sub">${item.subProd2 || ""}</p>
            </div>
            <div class="item-side">
              <a href="/guide/default/${item.guideUrl}" class="detail-btn">상세보기</a>
            </div>
          </div>
        `;
      }

      if (category === "상품" && ["ETF", "TDF", "펀드"].includes(subCategory)) {
        return `
          <div class="result-item">
            <div class="item-main">
              <p class="item-title">${highlight(item.prodName, kw)}</p>
              <p class="item-snippet">유형: ${item.fundTypeCd || "-"} / 위험도: ${item.risk || "-"}</p>
              <p class="item-sub">운용사: ${item.manager || "-"}</p>
            </div>
          </div>
        `;
      }

      if (category === "상품" && subCategory === "원리금보장") {
        return `
          <div class="result-item">
            <div class="item-main">
              <p class="item-title">${highlight(item.prodName, kw)}</p>
              <p class="item-snippet">은행: ${item.bank}</p>
              <p class="item-sub">만기일: ${item.maturityDate}</p>
            </div>
          </div>
        `;
      }

      if (category === "매뉴얼") {
        return `
          <div class="result-item">
            <div class="item-main">
              <p class="item-title">${highlight(item.title, kw)}</p>
              <p class="item-snippet">${highlight(item.fileName, kw)}</p>
            </div>
            <div class="item-side">
              <span class="item-date">${item.createdDate}</span>
              <a href="/manual/${item.fileName}" class="detail-btn">다운로드</a>
            </div>
          </div>
        `;
      }

      if (category === "공시") {
        return `
          <div class="result-item">
            <div class="item-main">
              <p class="item-title">${highlight(item.docTitle, kw)}</p>
            </div>
            <div class="item-side">
              <a href="/disclosure/${item.filePath}" class="detail-btn">다운로드</a>
            </div>
          </div>
        `;
      }

      if (category === "FAQ" || category === "자주찾는질문") {
        return `
          <div class="result-item">
            <div class="item-main">
              <p class="item-title">${highlight(item.question, kw)}</p>
              <p class="item-snippet">${highlight(item.answer, kw)}</p>
              <p class="item-sub">유형: ${item.mainType}</p>
            </div>
          </div>
        `;
      }

      if (category === "공지사항") {
    	  return `
    	    <div class="result-item">
    	      <div class="item-main">
    	        <p class="item-title">${highlight(item.btitle, kw)}</p>
    	        <p class="item-snippet">${highlight(item.bcontent, kw)}</p>
    	      </div>
    	      <div class="item-side">
    	        <span class="item-date">${formatDateTime(item.bcreatedAt)}</span>
    	      </div>
    	    </div>
    	  `;
    	}




      return `
        <div class="result-item">
          <div class="item-main">
            <p class="item-title">지원되지 않는 항목</p>
          </div>
        </div>
      `;
    }

    function highlight(text, kw) {
      if (!text || !kw) return text;
      const regex = new RegExp(`(${kw})`, 'gi');
      return text.replace(regex, "<mark>$1</mark>").replace(/\\n/g, "<br>");
    }
    
    function formatDateTime(dateTimeString) {
   	  const date = new Date(dateTimeString);
   	  const yyyy = date.getFullYear();
   	  const mm = String(date.getMonth() + 1).padStart(2, '0');
   	  const dd = String(date.getDate()).padStart(2, '0');
   	  return `${yyyy}.${mm}.${dd}`;
   	}
    
    document.querySelectorAll(".tab-btn").forEach(btn => {
   	  btn.addEventListener("click", () => {
   	    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
   	    btn.classList.add("active");

   	    const group = btn.dataset.group;
   	    const container = document.getElementById("search-results");

   	    // 기존 애니메이션 제거
   	    container.classList.remove("fade-animate");

   	    // 콘텐츠 렌더링
   	    renderSections(group);

   	    // 애니메이션 클래스 부여 (짧은 delay 후)
   	    requestAnimationFrame(() => {
   	      container.classList.add("fade-animate");
   	    });
   	  });
   	});



  </script>
</body>
</html>
